<!DOCTYPE html>
<html
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout}"
    lang="en"
>
<head>
    <title>Home â—† WeightTracker</title>

    <link type="text/css" rel="stylesheet" th:href="@{/public/css/pages/home.css}"  />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <main layout:fragment="content">
        <section class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h1>Your Weight Journey</h1>
                <div>
                    <a
                        class="btn btn-primary"
                        href="/weights/add"
                        role="button"
                    >
                        <i class="bi bi-plus me-1"></i>
                        Add Weight
                    </a>
                </div>
            </div>
            <div>
                <div th:if="firstEntryDate != null">
                    Your first entry was on the [[${firstEntryDate}]].
                </div>
                <div th:if="lastEntryDate != null">
                    Your last entry was on the [[${lastEntryDate}]].
                </div>
            </div>
            <canvas id="weight-chart"></canvas>
        </section>
    </main>

    <script layout:fragment="script" th:inline="javascript">
        /*<![CDATA[*/
        let weightEntries = /*[[${weightEntries}]]*/ [];
        let user = /*[[${user}]]*/ {};
        /*]]>*/

        const labels = weightEntries.map(weightEntry => {
            const date = new Date(weightEntry.date);
            return date.toDateString();
        });

        const values = weightEntries.map(weightEntry => {
            return weightEntry.weight
        });

        const data = {
            labels,
            datasets: [{
                label: 'My Weight Journey',
                backgroundColor: 'rgb(255, 99, 132)',
                borderColor: 'rgb(255, 99, 132)',
                data: values,
            }]
        };

        const config = {
            type: 'line',
            data,
            options: {
                onClick: (e) => {
                    const canvasPosition = Chart.helpers.getRelativePosition(e, chart);
                    const dataX = chart.scales.x.getValueForPixel(canvasPosition.x);
                    const dataY = chart.scales.y.getValueForPixel(canvasPosition.y);
                    const weightEntry = weightEntries[dataX];
                    if (dataY >= weightEntry.weight - 1 && dataY <= weightEntry.weight + 1) {
                        location.href = `/weights/${weightEntry.id}/edit`
                    }
                },
            }
        };

        const chart = new Chart(
            document.getElementById('weight-chart'),
            config
        );
    </script>
</body>
</html>